<!DOCTYPE html>
{% load static %}
<html>
<head>
    <title>Activity Map</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="{% static 'markers/leaflet.awesome-markers.css' %}">
    <script src="{% static 'markers/leaflet.awesome-markers.js' %}"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        #marker-info {
            flex: 0 0 15%;
            max-width: 15%;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="marker-info">
    <h2>Marker Info</h2>
    <ul id="marker-list">
        <!-- Placeholder for marker information -->
    </ul>
</div>

<script>
    var map = L.map('map').setView([48.5, 35], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Загрузка данных маркеров через API
    fetch('/api/markers/')
        .then(response => response.json())
        .then(data => {
            // Создаем объект для хранения информации о маркерах с одинаковым местоположением и активностью
            var markerDataByLocationAndActivity = {};

            // Обрабатываем каждую запись из полученных данных
            data.forEach(marker => {
                var lat = marker.location[0];
                var lon = marker.location[1];
                var activity = marker.activity;
                var quantity = marker.quantity;
                var date = marker.date;
                var place = marker.place;
                var iconClass = marker.icon; // Иконка для активности из базы данных
                var color = marker.color; // Цвет для активности из базы данных

                // Формируем уникальный ключ на основе местоположения и активности
                var key = lat.toString() + lon.toString() + activity;

                // Если такой ключ уже существует, добавляем информацию в объект
                if (key in markerDataByLocationAndActivity) {
                    markerDataByLocationAndActivity[key].push({
                        activity: activity,
                        quantity: quantity,
                        date: date,
                        place: place
                    });
                } else {
                    // Если ключа еще нет, создаем новую запись в объекте
                    markerDataByLocationAndActivity[key] = [{
                        activity: activity,
                        quantity: quantity,
                        date: date,
                        place: place
                    }];

                    // Создаем иконку с использованием AwesomeMarkers
                    var icon = L.AwesomeMarkers.icon({
                        icon: iconClass, // Иконка для активности из базы данных
                        prefix: 'fa', // Префикс класса иконок Font Awesome
                        markerColor: color // Цвет маркера для активности из базы данных
                    });

                    // Добавляем маркер на карту и обработчик клика
                    var markerPopup = L.popup().setContent(`<b>${place}</b><br>Activity: ${activity}<br>Quantity: ${quantity}<br>Date: ${date}`);
                    L.marker([lat, lon], { icon: icon }).addTo(map).bindPopup(markerPopup).on('click', function() {
                        // Отображаем информацию о маркерах в боковом меню
                        var markerInfoList = document.getElementById('marker-list');
                        markerInfoList.innerHTML = ''; // Очищаем список

                        // Получаем все записи с данным ключом и добавляем их в список
                        var markerDataList = markerDataByLocationAndActivity[key];
                        markerDataList.forEach(markerData => {
                            var listItem = document.createElement('li');
                            listItem.innerHTML = `<b>${markerData.place}</b><br>Activity: ${markerData.activity}<br>Quantity: ${markerData.quantity}<br>Date: ${markerData.date}`;
                            markerInfoList.appendChild(listItem);
                        });
                    });
                }
            });
        });
</script>




</body>
</html>